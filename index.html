<!doctype HTML>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<title>KAS Live</title>
	<link href="assets/css/bootstrap-theme.css" rel="stylesheet">

	<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700" rel="stylesheet">

	<script   src="https://code.jquery.com/jquery-3.1.1.min.js"   
	integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="   crossorigin="anonymous"></script>

	<script src="assets/js/time.js" ></script>

	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

	<!-- Optional theme -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

	<!-- Latest compiled and minified JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

	<link rel="stylesheet" type="text/css" href="style.css">

	<script src="assets/js/tabletop-master/src/tabletop.js"></script>
	<script src="assets/js/underscore.js"></script>
	<script src="assets/js/jquery.webticker.min.js"></script>
	<script src="https://use.fontawesome.com/31f4a97978.js"></script>


	
	
</head>
<body>
	<?php
		echo "mi scripto primero";
	?>
	<div class="container-fluid">
		<div class="row margin-spacing">
			<div class="col-md-9">
				<div class="row">
					<img src="assets/kas.png" class="img-responsive center-block" alt="kas logo" style="width:10%"/>

					</div>
				<div class="row vertical-align">
					<div class="text-center news-ticker" id="n-ticker">COOL NEWS TICKER</div>
				</div>
				<div class="row vertical-align margin-spacing">
					<div class="col-md-12 text-center embed-responsive embed-responsive-16by9">
						<div id="canvas"><!-- VIDEO --></div>
					</div>
				</div>
			</div>
			<div class="col-md-3">
				<div class="row margin-spacing text-center">
					<div class="col-md-12">
						<span id="time"></span> <span id="ampm"></span><br>
						<span id="cal"></span>
					</div>
				</div>
				
				<div class="row text-center margin-spacing">
					<div class="col-md-6">
						<div class="text-center">
							<span class="data-header">MS Block</span><br>
							<span id="ms" class="data"></span>
						</div>
					</div>
					<div class="col-md-6">
						<div class="text-center">
							<span class="data-header">HS Block</span><br>
							<span id="hs" class="data"></span>
						</div>
					</div>
				</div>
				<div class="row vertical-align margin-spacing icon-spacing">
					<div class="icon col-md-3">
						<i class="fa fa-cloud"></i>
					</div>
					<div class="col-md-9">
						<span class="data" id="aqi"></span> <span class="data-header">AQI</span><br>
						<span class="data" id="temp">21</span><span class="data-header">°C</span>
					</div>
				</div>
				<div class="row">
					<!-- cal -->
				</div>
				<div class="row margin-spacing icon-spacing">
					<div class="icon col-md-3">
						<i class="fa fa-twitter" aria-hidden="true"></i>
					</div>
					<div class="col-md-9">TWITTER
					<a class="twitter-timeline" href="https://twitter.com/hashtag/kastw" data-widget-id="809242130971398144">#kastw Tweets</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script></div>

				</div>
				<div class="row margin-spacing icon-spacing text-left" >
					<div class="icon col-md-3">
						<i class="fa fa-calendar"></i>
					</div>
					<div class="col-md-9">
						<span id="calendar-block"></span>
					</div>
				</div>
			</div>
		</div>

	</div>
	<script>
	// YouTube loading
		var yttag = document.createElement('script');
		yttag.src = 'https://www.youtube.com/iframe_api';
		var firstScriptTag = document.getElementsByTagName('script')[0];
		firstScriptTag.parentNode.insertBefore(yttag, firstScriptTag);
		console.log(document.getElementsByTagName('script')[0]);

		var isYTready=false;

		function onYouTubeIframeAPIReady() {
			// alert("BANG");
			isYTready=true;
		}

		function onPlayerReady(event) {
			
		}

		function onPlayerStateChange(event) {
			if (event.data == 0) {
				playMedia();
			}
		}		
	</script>


	<script>
		// SECTION FOR WORKING ON CANVAS
		// http://stackoverflow.com/questions/13807788/web-based-fullscreen-slideshow-with-video-elements (cc-by-sa 3.0)
		var content = ["assets/placeholder.jpg", "http://www.youtube.com/embed/qs9bJuGRs84", "assets/placeholder2.jpg", "assets/bbb.mp4"];
		var canvas = $('#canvas');
		var imgsrc = '<img src="$" alt="" class="img-responsive center-block"/>';
		var imgDuration = 5000; //ms
		var vidsrc = '<video autoplay class="embed-responsive-item"><source src="$" type="video/mp4"></source></video>';
		var ytsrc = '<iframe id="yt" src="$"></iframe>'
		var current = -1;
		var regex = /(?:\.([^.]+))?$/;
		var imgTypes = ["png", "jpg", "jpeg"];
		var vidTypes = ["mov", "mp4", "m4v"];
		var player;
		



		function playMedia() {
			++current;
			if (content.length == current) {
				current = 0;
			}

			var source = null;
			var file = content[current];
			var extension = regex.exec(file)[1];
			if (imgTypes.includes(extension)) {
				source = imgsrc.replace('$', file);
			}

			if (vidTypes.includes(extension)) {
				source = vidsrc.replace('$', file);
			}

			if (file.includes("youtube.com")) {
				file = file + "?enablejsapi=1&autoplay=1";
				source = ytsrc.replace('$', file);
				// alert(file);
			}

			// alert(file);

			if (null !== source) {
				canvas.html(source);
				if (imgTypes.includes(extension)) {
					//it's a photo!
					setTimeout(function() {playMedia();}, imgDuration);
				}

				if (vidTypes.includes(extension)) {
					//it's a video!
					console.log('vido')
					canvas.find('video').bind("ended", function() {
						playMedia();
					});
				}

				if (file.includes("youtube")) {
					if (isYTready) {
						player = new YT.Player('yt', {
							events: {
								'onReady': onPlayerReady,
								'onStateChange': onPlayerStateChange
							}
						});
					}

					}
			}
		}



	</script>

	<script>
		var weatherApikey = "aaa5dabae3d52948d6e95364427ad305"
		var weatherurl = "http://api.openweathermap.org/data/2.5/weather?q=Kaohsiung&units=metric&APPID="
		var jsonweather = weatherurl+weatherApikey;

		function getWeather() {
			$.ajax({
				url: jsonweather,
				dataType: "jsonp",
				success: function(jcal) {
					var currentTemperature = jcal.main.temp;
					$('#temp').html(currentTemperature);
				}
			})
		}

		
	</script>

	<script type="text/javascript">

		//new idea brief for next time
		//we have two arrays and we fetch a new array or something

		var public_spreadsheet_url = 'https://docs.google.com/spreadsheets/d/11Z_TJTHhb7Ivuq5swt5HYnJTSl9-cGMo3kKQ5768VUM/pubhtml';
		  var array = []; //i need a better name; array for info
		  function init() {
		  	Tabletop.init( { key: public_spreadsheet_url,
		  		callback: showInfo,
		  		simpleSheet: true } )
		  }

		  function showInfo(data, tabletop) {
		  	newArray = []
		  	$.each(data, function(index, item) {
		  		newArray.push(data[index].Announcements)
		  	})
		  	array.sort();
		  	newArray.sort();
		  	if(_.isEqual(array, newArray)) {
		  	} else {
		  		array = newArray;
		  		callTicker();
		  	}
		  }

		  function callTicker() {
		  	var html = ""
		  	$.each(array, function(index, item) {
		  		html += "<li> | " + array[index] + "</li>"
		  	})
		 		// $('#tickers').html("");
		 		$('#n-ticker').append(html);
		 		$('#n-ticker').webTicker('update', html, 'swap', true, false)
		 	}
		 </script>

		 <script>
		 	function getAQI() {

	// IDK actually how to use webservices but this seems to work??
	//http://opendata.epa.gov.tw/Data/Details/AQI/?show=all
	$.ajax({
		url: "http://opendata.epa.gov.tw/webapi/api/rest/datastore/355000000I-001805?filters=SiteName%20eq%20'左營'&sort=SiteName&offset=0&format=json&token=+FnNny1OD023y6sJSIyDmA",
		dataType: "jsonp",
		success: function(data) {
		// var json = $.parseJSON(data);
		var json = data;

		for (arr in json.result.records) {
			var site = json.result.records[arr].SiteName;
			if (site == "左營") {
				// var pm = json.result.records[arr]["PM2.5"]
				var aqi = json.result.records[arr]["AQI"]
				// var update = json.result.records[arr]["PublishTime"]
				//TESTING USE BECAUSE ITS DUMB AND NOT WORKING
				// pm = 200	;

				

				var aqiquality;
				$('#aqi').removeClass("air-good air-moderate air-unhealthsensitive air-unhealthy air-veryunhealthy air-hazardous");

				if (!aqi) {
					aqiquality = "--"
				} else if (aqi < 51) {
					aqiquality = "Good"
					$('#aqi').addClass("air-good")
				} else if (aqi < 101) {
					aqiquality = "Moderate"
					$('#aqi').addClass("air-moderate")
				} else if (aqi < 151) {
					aqiquality = "Unhealthy for sensitive groups"
					$('#aqi').addClass("air-unhealthsensitive")
				} else if (aqi < 201) {
					aqiquality = "Unhealthy"
					$('#aqi').addClass("air-unhealthy")
				} else if (aqi < 301) {
					aqiquality = "Very unhealthy"
					$('#aqi').addClass("air-veryunhealthy")
				} else {
					aqiquality = "Hazardous"
					$('#aqi').addClass("air-hazardous")
				}

				$('#aqi').html(aqi);
				$('#updatetime').html(update);

			}
		}
		
	}
});
}
</script>

<script>
	var calendarKey = "kas.kh.edu.tw_iv193c4dfh6prrut4cn5f1k8h4@group.calendar.google.com";
	var APIkey = "AIzaSyAhLZQoSUvAJrXgpqNlilhgcxng1tAuj4o";
	var numOfResults = 4;

	var calJson = "https://www.googleapis.com/calendar/v3/calendars/" + calendarKey + "/events?key=" + APIkey + "&timeMin=" + new Date().toISOString() + "&maxResults=" + numOfResults + "&singleEvents=true&orderBy=startTime";


	// console.log(calJson);

	function getCal() {
		$.ajax({
			url: calJson,
			dataType: "jsonp",
			success: function(caldata) {
				var calText = ""
				for (evt in caldata.items) {
					var eventName = caldata.items[evt].summary;
					var eventDate = caldata.items[evt].start.date;
					// console.log(caldata.items[evt].summary);
					// console.log(caldata.items[evt].start)
					calText += "<span class='caldate'>" + eventDate + "</span><br>";
					calText += "<span class='calevent'>" + eventName + "</span><br>";
				}
				$('#calendar-block').append(calText);

			}
		});
	}
</script>

<script>
	$(document).ready(function() {
		myTime();
		init();
		getAQI();
		getCal(); //make this refresh as well
		playMedia(); //need a way to update
		getWeather();

		if (window.File && window.FileReader) {
			alert("YE");
		} else {
			alert("NO");
		}

		var aqiRefresh = setInterval(getAQI, 1000 * 1800); //update every half hour
		var tickerRefresh = setInterval(init, 1000 * 600); //10 min update interval
		var weatherRefresh = setInterval(getWeather, 1000 * 1200); //20 min update interval
		var calendarRefresh = setInterval(getCal, 1000 * 3600 * 4); // unlikely that this needs to be updated frequently
	});
</script>
<script>
	$('#n-ticker').webTicker({
		height: '36px',
		speed: 75,
		hoverpause: false,
		duplicate: true,
		startEmpty: true,
	});
</script>



</body>
</html>